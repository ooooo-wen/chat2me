version: '3.8'

services:
  # ğŸ”¥ HTTPS ä»£ç† + æ†‘è­‰æœå‹™
  nginx-proxy:
    image: jwilder/nginx-proxy
    container_name: ${PROJECT_NAME}-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certs:/etc/nginx/certs
      - ./vhost.d:/etc/nginx/vhost.d     # âœ… é—œéµ volume
      - ./html:/usr/share/nginx/html     # âœ… é—œéµ volume
      - /var/run/docker.sock:/tmp/docker.sock:ro

  letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    container_name: ${PROJECT_NAME}-letsencrypt
    environment:
      NGINX_PROXY_CONTAINER: ${NGINX_PROXY_CONTAINER}
    volumes:
      - ./certs:/etc/nginx/certs
      - ./vhost.d:/etc/nginx/vhost.d     # âœ… å¿…é ˆè·Ÿ nginx-proxy å…±ç”¨
      - ./html:/usr/share/nginx/html     # âœ… å¿…é ˆè·Ÿ nginx-proxy å…±ç”¨
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # âœ… ä½ çš„è³‡æ–™åº«
  db:
    image: postgres:alpine
    container_name: ${PROJECT_NAME}-postgres
    environment:
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_DATABASE}
    ports:
      - "${DB_PORT}:${DB_PORT}"
    volumes:
      - db-data:/var/lib/postgresql/data

  # âœ… ä½ çš„ Node.js App
  app:
    build: .
    container_name: ${PROJECT_NAME}-app
    env_file: .env
    depends_on:
      - db
    expose:
      - "${PORT}"
    environment:
      - VIRTUAL_HOST=chat2me.ubddns.org
      - LETSENCRYPT_HOST=chat2me.ubddns.org
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}

volumes:
  db-data:
